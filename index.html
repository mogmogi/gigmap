<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
<title>GigMap ‚ö° // Secure Edition üôÜ‚Äç‚ôÄÔ∏è</title>

<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<style>
:root { --bg: #fafafa; --accent: #ff4d00; --text: #1a1a1a; --border: #e8e8e8; }
* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
body { font-family: 'Space Mono', monospace; background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; position: fixed; width: 100%; }
#app { display: flex; height: 100vh; width: 100vw; position: relative; }

/* SIDEBAR */
#sidebar { 
    width: 260px; flex-shrink: 0; display: flex; flex-direction: column; 
    background: #fff; border-right: 1px solid var(--border); z-index: 1001; 
    transition: transform 0.3s ease;
}

#sidebar-header { padding: 20px 20px 10px; border-bottom: 1px solid var(--border); cursor: pointer; }
#sidebar-header h1 { font-size: 16px; font-weight: 700; text-transform: uppercase; letter-spacing: -0.5px; }
#sidebar-header h1 span { color: var(--accent); }

#quick-guide { padding: 12px 20px; font-size: 8.5px; line-height: 1.4; color: #666; background: #fdfdfd; border-bottom: 1px solid var(--border); }
#quick-guide b { color: var(--text); text-transform: uppercase; font-size: 9px; display: block; margin-bottom: 4px; }

#filters { padding: 12px 20px; display: flex; flex-direction: column; gap: 8px; border-bottom: 1px solid var(--border); }
#month-pills { display: flex; flex-wrap: wrap; gap: 3px; }
.mpill { background: #f5f5f5; border: none; padding: 4px 8px; font-size: 8px; cursor: pointer; font-family: inherit; color: #666; }
.mpill.on { background: var(--text); color: #fff; font-weight: bold; }

.action-row { display: flex; flex-direction: column; gap: 6px; margin-top: 5px; }
.btn-main { background: var(--accent); color: #fff; border: none; padding: 10px; font-family: inherit; font-weight: 700; cursor: pointer; text-transform: uppercase; font-size: 9px; }
.btn-secondary { border: 1px solid var(--border); background: #f8f8f8; padding: 8px; font-family: inherit; cursor: pointer; text-transform: uppercase; font-size: 9px; color: var(--text); font-weight: 700; }

#legend { padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 8px; border-bottom: 1px solid var(--border); }
.lpill { display: flex; align-items: center; gap: 5px; cursor: pointer; font-size: 8px; color: #888; }
.lpill.on { color: var(--text); font-weight: 700; }
.ldot { width: 5px; height: 5px; border-radius: 50%; }

#gig-list { flex: 1; overflow-y: auto; }
.grow { padding: 10px 20px; cursor: pointer; border-bottom: 1px solid #f9f9f9; }
.grow.sel { border-left: 3px solid var(--accent); background: #fcfcfc; }
.grow b { font-size: 11px; display: block; margin-bottom: 2px; text-transform: uppercase; }
.grow small { font-size: 8.5px; color: #999; display: block; line-height: 1.4; }

/* MOBILE ELEMENTS */
#mobile-toggle {
    display: none; position: fixed; bottom: 20px; left: 20px; z-index: 2000;
    width: 50px; height: 50px; border-radius: 25px; background: var(--accent);
    color: white; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    font-size: 20px; cursor: pointer; align-items: center; justify-content: center;
}

@media (max-width: 768px) {
    #sidebar { position: absolute; left: 0; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 4px 0 15px rgba(0,0,0,0.1); }
    #sidebar.open { transform: translateX(0); }
    #mobile-toggle { display: flex; }
}

/* OK GESTURE ANIMATION üôÜ‚Äç‚ôÄÔ∏è */
.ok-floating {
    position: fixed; bottom: -50px; left: 50%; z-index: 9999; font-size: 40px;
    animation: floatUp 3s ease-out forwards; pointer-events: none;
}
@keyframes floatUp {
    0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
    20% { opacity: 1; }
    100% { transform: translate(-50%, -100vh) scale(1.5); opacity: 0; }
}

/* MAP & TOOLTIP */
#map-wrap { flex: 1; position: relative; background: #f0f0f0; }
#map { position: absolute; inset: 0; z-index: 1; }
.artist-tooltip { 
    background: var(--text) !important; border: none !important; border-radius: 2px !important; 
    color: #fff !important; font-family: 'Space Mono', monospace !important; 
    font-size: 9px !important; padding: 4px 8px !important;
}

/* MODALS */
.overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.94); display: flex; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(4px); }
.modal { background: #fff; border: 1px solid var(--border); padding: 25px; width: 100%; max-width: 450px; position: relative; }
.close-modal { position: absolute; top: 12px; right: 12px; cursor: pointer; font-size: 12px; color: #ccc; }
.tabs { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
.tab { cursor: pointer; font-size: 9px; font-weight: bold; text-transform: uppercase; color: #ccc; }
.tab.active { color: var(--text); border-bottom: 2px solid var(--text); }
textarea { width: 100%; height: 130px; margin: 10px 0; border: 1px solid var(--border); font-family: inherit; font-size: 10px; padding: 10px; resize: none; outline: none; background: #fafafa; }
</style>
</head>
<body>

<button id="mobile-toggle" onclick="toggleSidebar()">‚ò∞</button>

<div id="app">
  <div id="sidebar">
    <div id="sidebar-header" onclick="triggerOk()">
      <h1>GIG_MAP <span>‚ö°</span></h1>
      <p id="gig-count" style="font-size:8px; color:#999; margin-top:2px;">00 CONCERTS DETECTED</p>
    </div>

    <div id="quick-guide">
        <b>HOW TO USE:</b>
        1. Click 'AI Prompt Gen' & enter artists.<br>
        2. Paste prompt into Gemini/AI.<br>
        3. Copy the CSV result & click '+ Add Data'.
    </div>

    <div id="filters">
      <div id="month-pills">
        <script>
            for(let i=1; i<=12; i++) document.write(`<button id="mpill-${i}" class="mpill" onclick="tglM(${i})">${i.toString().padStart(2,'0')}</button>`);
        </script>
      </div>
      <div class="action-row">
        <button class="btn-secondary" onclick="openPromptGen()">AI_PROMPT_GEN</button>
        <button class="btn-main" onclick="openImp()">+ ADD_DATA</button>
      </div>
    </div>
    <div id="legend"></div>
    <div id="gig-list"></div>
  </div>
  <div id="map-wrap"><div id="map"></div></div>
</div>

<div id="m-imp" class="overlay" style="display:none" onclick="if(event.target===this)closeImp()">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="close-modal" onclick="closeImp()">[X]</div>
    <div class="tabs">
        <div id="tab-paste" class="tab active" onclick="switchTab('paste')">Paste CSV</div>
        <div id="tab-file" class="tab" onclick="switchTab('file')">Upload File</div>
    </div>
    <div id="view-paste"><textarea id="paste-area" placeholder="PASTE_CSV_CODE_HERE..."></textarea></div>
    <div id="view-file" style="display:none">
        <div style="border:1px dashed #ddd; padding:30px; text-align:center; font-size:9px;" onclick="document.getElementById('fin').click()">
            <span id="drop-text">üìÇ Click to Upload CSV</span>
        </div>
        <input id="fin" type="file" accept=".csv" style="display:none" onchange="hFile(event)"/>
    </div>
    <div id="prog" style="display:none; font-size: 9px; margin: 10px 0; color: var(--accent); font-weight: bold;">GEOLOCATING CITIES...</div>
    <button class="btn-main" style="width:100%; margin-top:10px;" id="btn-process" onclick="processData()">EXECUTE IMPORT</button>
  </div>
</div>

<div id="m-prompt" class="overlay" style="display:none" onclick="if(event.target===this)closePrompt()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="close-modal" onclick="closePrompt()">[X]</div>
      <h2 style="font-size: 12px; text-transform: uppercase;">AI PROMPT GENERATOR</h2>
      <input type="text" id="artist-names" placeholder="e.g. Idles, Osees" style="width: 100%; padding: 10px; border: 1px solid var(--border); font-family: inherit; font-size: 10px; margin: 15px 0; outline: none;">
      <button class="btn-main" style="width:100%;" id="copy-btn" onclick="generatePrompt()">Copy Full Prompt</button>
    </div>
</div>

<script>
const MF = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
const PAL = ["#ff4d00","#1a1a1a","#2b5e4c","#4a9eca","#6dbf7e","#e85d4a"];
let gigs = [], map, clusterGroup, activeM = new Set(), activeArt = 'all', currentMode = 'paste', imping = false, selId = null;

function triggerOk() {
    for(let i=0; i<8; i++) {
        setTimeout(() => {
            const el = document.createElement('div');
            el.className = 'ok-floating';
            el.innerHTML = 'üôÜ‚Äç‚ôÄÔ∏è';
            el.style.left = (Math.random() * 80 + 10) + '%';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }, i * 200);
    }
}

function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function openImp() { document.getElementById('m-imp').style.display='flex'; }
function closeImp() { if(!imping) document.getElementById('m-imp').style.display='none'; }
function openPromptGen() { document.getElementById('m-prompt').style.display='flex'; }
function closePrompt() { document.getElementById('m-prompt').style.display='none'; document.getElementById('copy-btn').innerText = 'Copy Full Prompt'; }

function switchTab(m) {
    currentMode = m;
    document.getElementById('tab-paste').classList.toggle('active', m==='paste');
    document.getElementById('tab-file').classList.toggle('active', m==='file');
    document.getElementById('view-paste').style.display = m==='paste' ? 'block' : 'none';
    document.getElementById('view-file').style.display = m==='file' ? 'block' : 'none';
}

function generatePrompt() {
    const names = document.getElementById('artist-names').value;
    if(!names) return;
    
    const today = new Date().toISOString().split('T')[0];
    
    // ◊§◊î ◊ë◊†◊ô◊™◊ô ◊ê◊™ ◊î"◊û◊ë◊†◊î ◊î◊ß◊©◊ô◊ó" ◊©◊ú ◊î◊§◊®◊ï◊û◊§◊ò
    const p = `Subject: Generate Future Gig List for GigMap (STRICT CSV FORMAT)\n\nArtists: ${names}.\n\nSTRICT RULES:\n1. Include ONLY dates from ${today} onwards.\n2. Use EXACTLY these headers in this order: Artist, City, Venue, Date, Month, Year, Ticket Link.\n3. Date format MUST be YYYY-MM-DD.\n4. Month MUST be a number (1-12).\n5. Source: Songkick only.\n6. Provide RAW CSV code block ONLY. No intro, no outro.`;
    
    const btn = document.getElementById('copy-btn');
    if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(p).then(() => { btn.innerText = 'COPIED!'; setTimeout(closePrompt, 1000); });
    } else {
        const textArea = document.createElement("textarea");
        textArea.value = p; document.body.appendChild(textArea); textArea.select();
        try { document.execCommand('copy'); btn.innerText = 'COPIED!'; setTimeout(closePrompt, 1000); } catch (err) { alert('Copy failed.'); }
        document.body.removeChild(textArea);
    }
}

async function processData() {
    let txt = "";
    if(currentMode==='paste') txt = document.getElementById('paste-area').value;
    else if(document.getElementById('fin').files[0]) txt = await document.getElementById('fin').files[0].text();
    if(!txt) return;

    imping = true; document.getElementById('prog').style.display = 'block';
    const lines = txt.split('\n');
    const headers = lines[0].toLowerCase().split(',').map(h=>h.trim());

    for(let r of lines.slice(1).filter(l=>l.trim())) {
        const cols = r.split(',').map(c=>c.trim());
        const d = {}; headers.forEach((h,i)=> d[h]=cols[i]);
        if(!d.artist || !d.city) continue;

        const isDup = gigs.some(g => g.artist.toLowerCase() === d.artist.toLowerCase() && g.city.toLowerCase() === d.city.toLowerCase() && g.date === d.date);
        if(isDup) continue;

        const geo = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(d.city)}&format=json&limit=1`).then(res=>res.json());
        if(geo[0]) {
            let mNum = parseInt(d.month) || (MF.findIndex(n => (d.month||"").toUpperCase().includes(n)) + 1);
            gigs.push({ id: Math.random(), artist: d.artist, city: d.city, venue: d.venue||d.city, date: d.date, month: mNum || 1, lat: +geo[0].lat, lng: +geo[0].lon });
        }
        await new Promise(r => setTimeout(r, 400));
    }
    imping = false; document.getElementById('prog').style.display = 'none'; closeImp(); refresh();
    triggerOk();
}

function refresh() {
    const arts = [...new Set(gigs.map(g=>g.artist))].sort();
    const filtered = gigs.filter(g => (activeM.size === 0 || activeM.has(g.month)) && (activeArt === 'all' || g.artist === activeArt)).sort((a,b) => new Date(a.date) - new Date(b.date));
    
    document.getElementById('gig-count').innerText = `${filtered.length.toString().padStart(2,'0')} CONCERTS DETECTED`;
    for(let i=1; i<=12; i++) {
        const el = document.getElementById(`mpill-${i}`);
        if(el) el.classList.toggle('on', activeM.has(i));
    }
    document.getElementById('legend').innerHTML = arts.map(a => `<div class="lpill ${activeArt===a?'on':''}" onclick="tglA('${a}')"><div class="ldot" style="background:${PAL[arts.indexOf(a)%PAL.length]}"></div>${a}</div>`).join('');
    
    clusterGroup.clearLayers();
    filtered.forEach(g => {
        const color = PAL[arts.indexOf(g.artist) % PAL.length];
        const sz = g.id === selId ? 22 : 14;
        const mk = L.marker([g.lat, g.lng], {
            icon: L.divIcon({
                className: '',
                html: `<div style="width:${sz}px;height:${sz}px;border-radius:50%;background:${color};border:2.5px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.15)"></div>`,
                iconSize: [sz, sz], iconAnchor: [sz/2, sz/2]
            })
        });

        mk.bindPopup(`<div style="font-family:'Space Mono';text-transform:uppercase;"><b style="color:var(--accent);">${g.artist}</b><br><div style="margin-top:5px;font-weight:700;">${g.venue}</div><div style="color:#666;">${g.city}</div><div style="margin-top:8px;border-top:1px solid #eee;padding-top:5px;">üìÖ ${g.date}</div></div>`, { closeButton: true });
        mk.bindTooltip(`${g.artist.toUpperCase()} // ${g.date}`, { permanent: false, direction: 'top', className: 'artist-tooltip', offset: [0, -sz/2] });

        mk.on('click', () => { 
            selId = g.id; refresh(); 
            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
        });
        clusterGroup.addLayer(mk);
    });

    document.getElementById('gig-list').innerHTML = filtered.map(g => `<div class="grow ${g.id===selId?'sel':''}" onclick="flyTo(${g.id})"><b>${g.venue}</b><small>${g.artist} // ${g.city}</small><small style="color:var(--accent); font-weight:700;">üìÖ ${g.date}</small></div>`).join('');
}

function flyTo(id) {
    const g = gigs.find(x => x.id === id);
    if (g) { selId = id; map.flyTo([g.lat, g.lng], 13); refresh(); if (window.innerWidth <= 768) toggleSidebar(); }
}
function tglM(m) { activeM.has(m) ? activeM.delete(m) : activeM.add(m); refresh(); }
function tglA(a) { activeArt = (activeArt === a) ? 'all' : a; refresh(); }
function hFile(e) { if(e.target.files[0]) document.getElementById('drop-text').innerHTML = `üìÑ ${e.target.files[0].name}`; }

window.addEventListener('load', () => {
    map = L.map('map', { center: [40, 0], zoom: 3, zoomControl: false });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
    clusterGroup = L.markerClusterGroup({ spiderfyOnMaxZoom: true, showCoverageOnHover: false, disableClusteringAtZoom: 16 }).addTo(map);
});
</script>
</body>
</html>